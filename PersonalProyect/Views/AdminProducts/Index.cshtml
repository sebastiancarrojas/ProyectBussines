@model PersonalProyect.ViewModels.Products.ProductsIndexViewModel


<!---------------------------------------------------------------------->
<!--------------------------- AdminLayout ------------------------------>
<!---------------------------------------------------------------------->

@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Productos";
}


<!---------------------------------------------------------------------->
<!----------------------------- Styles --------------------------------->
<!---------------------------------------------------------------------->
<!-- CSS de Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- Tema opcional de Select2 para Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    /* Estilos para el modal de confirmación */
    #deactivateModal .modal-dialog {
        max-width: 400px;
    }

    #deactivateModal .modal-body {
        padding: 2rem 1.5rem;
    }

    /* Animación para alertas toast */
    .alert-toast {
        animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    @@keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @@keyframes fadeOut {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }
    .modal-edit-product {
        max-width: 1100px; /* ~10% más que modal-lg */
    }

    .pagination {
        margin-bottom: 0;
    }

    .filter-pill {
        border-radius: 999px;
        height: 42px; /* antes 48 */
        font-size: 14px; /* antes 15 */
    }

    .filter-search {
        height: 40px;
        font-size: 14px;
    }


    .filter-pill::placeholder {
        color: #6c757d;
    }

    .form-select.filter-pill {
        padding-right: 2.5rem;
    }

    .btn-main.filter-pill {
        font-size: 15px;
    }


    body {
        background-color: #eef1f4;
    }

    .products-card {
        max-width: 1400px;
        margin: 1rem auto; /* antes 2rem */
        border-radius: 20px;
        background-color: #f8f9fa;
        box-shadow: 0 20px 40px rgba(0,0,0,.08);
        border: 1px solid #e3e6ea;
    }


    .filters-card {
        background-color: #f6f8fa; /* más cercano al fondo */
        border: 1px solid #e5e8eb;
    }



    .form-control,
    .form-select {
        border-radius: 12px;
    }

        .form-control:focus,
        .form-select:focus {
            border-color: #393d42;
            box-shadow: 0 0 0 .15rem rgba(57,61,66,.25);
        }

    .btn-main {
        background-color: #393d42;
        color: #fff;
        border-radius: 20px;
        padding: .5rem 1.6rem;
    }

        .btn-main:hover {
            background-color: #2f3338;
            color: #fff;
        }

    .table thead th {
        background-color: #f1f3f5;
        font-size: 14px;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .pagination .page-link {
        color: #393d42;
        border-radius: 10px;
    }

    .pagination .active .page-link {
        background-color: #393d42;
        border-color: #393d42;
        color: #fff;
    }

    #stockMin,
    #stockMax {
        width: 120px;
        min-width: 120px;
    }

    .text-muted {
        color: #6c757d !important;
    }

    .table td,
    .table th {
        padding: 0.55rem 0.75rem;
        font-size: 14px;
        vertical-align: middle;
    }


    }

</style>

<!-------------------------------------------------------------------->
<!----------------------------- View --------------------------------->
<!-------------------------------------------------------------------->

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">Gestión de Productos</h4>

    @if (ViewBag.ShowCreateButton == true)
    {
        <a class="btn btn-main" href="@Url.Action("Create", "AdminProducts")">
            <i class="bi bi-plus-circle"></i> Nuevo Producto
        </a>
    }
</div>


<!----------------------------- Filtros --------------------------------->
<div class="card filters-card p-3 mb-3">

    <!-- Fila principal -->
    <div class="d-flex align-items-center gap-3">

        <!-- Buscar -->
        <input type="text"
               id="filterInput"
               class="form-control filter-pill filter-search flex-grow-1"
               placeholder="Buscar por nombre o código" />

        <!-- Botón filtros (icon only, armonioso) -->
        <button class="btn btn-light filter-pill px-3"
                data-bs-toggle="collapse"
                data-bs-target="#advancedFilters"
                title="Filtros avanzados">
            <i class="bi bi-sliders"></i>
        </button>

    </div>

    <!-- Filtros avanzados (MISMO CARD) -->
    <div class="collapse mt-3" id="advancedFilters">
        <div class="d-flex flex-wrap gap-3 align-items-center">

            <select id="brandFilter" class="form-select filter-pill" style="width:160px">
                <option value="">Marcas</option>
                @foreach (var b in Model.Brands)
                {
                    <option value="@b.Id">@b.BrandName</option>
                }
            </select>

            <select id="categoryFilter" class="form-select filter-pill" style="width:170px">
                <option value="">Categorías</option>
                @foreach (var c in Model.Categories)
                {
                    <option value="@c.Id">@c.CategoryName</option>
                }
            </select>

            <select id="statusFilter" class="form-select filter-pill" style="width:140px">
                <option value="">Estado</option>
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
            </select>

            <input type="number"
                   id="stockMin"
                   class="form-control filter-pill"
                   placeholder="Stock mín" />

            <input type="number"
                   id="stockMax"
                   class="form-control filter-pill"
                   placeholder="Stock máx" />

            <button id="applyFilters"
                    class="btn btn-main filter-pill px-4">
                Aplicar
            </button>

        </div>
    </div>

</div>

<!-- <h6 class="mb-1 text-muted">Listado de productos</h6 -->

<!----------------------------- Tabla --------------------------------->
<div class="card products-card" id="productCard">
    <div id="loadingIndicator"
         class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center bg-white bg-opacity-75 invisible"
         style="z-index: 1000;">
        <div class="spinner-border" style="color:#393d42"></div>
        <div class="mt-2">Cargando productos...</div>
    </div>

    <div class="card-body p-3">

        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Código</th>
                        <th>Marca</th>
                        <th>Categoría</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Estado</th>
                        <th style="width:120px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
            </table>
        </div>

        <!----------------------------- Paginación --------------------------------->
        <nav class="mt-2">
            <ul class="pagination justify-content-center" id="paginationContainer"></ul>
        </nav>
    </div>
</div>
<!---------------------------------------------------------------------->
<!----------------------------- Modals --------------------------------->
<!---------------------------------------------------------------------->
<!-- Modal Editar Producto -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-edit-product">
        <div class="modal-content rounded-4">

            <div class="modal-header">
                <h5 class="modal-title">Editar producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="editProductId" />

                <div class="row g-3">

                    <div class="col-md-6">
                        <label class="form-label">Nombre</label>
                        <input type="text" id="editProductName" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Código</label>
                        <input type="text" id="editBarcode" class="form-control" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">Descripción</label>
                        <textarea id="editProductDescription" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Precio</label>
                        <input type="number" id="editUnitPrice" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Stock mínimo</label>
                        <input type="number" id="editStockMin" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Marca</label>
                        <select id="editBrandId" class="form-select select2 w-100">
                            <option value="">Seleccione</option>
                            @foreach (var b in Model.Brands)
                            {
                                <option value="@b.Id">@b.BrandName</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Categoría</label>
                        <select id="editCategoryId" class="form-select select2 w-100">
                            <option value="">Seleccione</option>
                            @foreach (var c in Model.Categories)
                            {
                                <option value="@c.Id">@c.CategoryName</option>
                            }
                        </select>
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-main" onclick="saveProductEdit()">Guardar cambios</button>
            </div>

        </div>
    </div>
</div>
<!-- Modal Desactivar Producto -->
<div class="modal fade" id="deactivateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Desactivar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <p id="deactivateMessage" class="mb-0">
                        ¿Estás seguro que deseas desactivar el producto?
                    </p>
                </div>
                <input type="hidden" id="deactivateProductId" />
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeactivate()">Desactivar</button>
            </div>
        </div>
    </div>
</div>



<!---------------------------------------------------------------------->
<!----------------------------- Script --------------------------------->
<!---------------------------------------------------------------------->
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        /* ======================================================
           MODAL: ABRIR CONFIRMACIÓN DE DESACTIVAR
        ====================================================== */
        function openDeactivateModal(productId, productName) {
            document.getElementById("deactivateProductId").value = productId;

            const messageElement = document.getElementById("deactivateMessage");
            messageElement.textContent = `¿Estás seguro que deseas desactivar el producto "${productName}"?`;

            const modalElement = document.getElementById("deactivateModal");

            // Limpiar evento anterior y agregar nuevo
            $(modalElement).off('hidden.bs.modal').on('hidden.bs.modal', function() {
                // Restaurar el botón si está en estado de carga
                const deactivateBtn = document.querySelector('#deactivateModal .btn-danger');
                if (deactivateBtn.disabled) {
                    deactivateBtn.innerHTML = 'Desactivar';
                    deactivateBtn.disabled = false;
                }
            });

            new bootstrap.Modal(modalElement).show();
        }
        /* ======================================================
           CONFIRMAR DESACTIVACIÓN (API CALL)
        ====================================================== */
        async function confirmDeactivate() {
            const productId = document.getElementById("deactivateProductId").value;

            console.log('DEBUG - Product ID:', productId);
            console.log('DEBUG - URL:', `https://localhost:7172/api/Product/${productId}/deactivate`);

            if (!productId) {
                alert("ID del producto no encontrado");
                return;
            }

            // Mostrar indicador de carga
            const deactivateBtn = document.querySelector('#deactivateModal .btn-danger');
            const originalText = deactivateBtn.innerHTML;
            deactivateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Desactivando...';
            deactivateBtn.disabled = true;

            try {
                // Llamar a la API de desactivación con PATCH
                console.log('DEBUG - Iniciando petición PATCH...');

                const response = await fetch(`https://localhost:7172/api/Product/${productId}/deactivate`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                console.log('DEBUG - Response status:', response.status);
                console.log('DEBUG - Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('DEBUG - Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('DEBUG - Result:', result);

                if (result.isSuccess) {
                    // Primero restaurar el botón
                    deactivateBtn.innerHTML = originalText;
                    deactivateBtn.disabled = false;

                    // Cerrar el modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById("deactivateModal"));
                    if (modal) modal.hide();

                    // Mostrar mensaje de éxito
                    showAlert('¡Producto desactivado exitosamente!', 'success');

                    // Refrescar la tabla
                    fetchProducts(currentPage);
                } else {
                    // Mostrar error
                    showAlert(result.message || 'Error al desactivar el producto', 'error');

                    // Restaurar botón
                    deactivateBtn.innerHTML = originalText;
                    deactivateBtn.disabled = false;
                }

            } catch (error) {
                console.error('DEBUG - Catch error:', error);
                showAlert(`Error: ${error.message}`, 'error');

                // Restaurar botón
                deactivateBtn.innerHTML = originalText;
                deactivateBtn.disabled = false;
            }
        }

        /* ======================================================
           FUNCIÓN PARA MOSTRAR ALERTAS (opcional pero útil)
        ====================================================== */
        function showAlert(message, type = 'info') {
            // Eliminar alerta anterior si existe
            const existingAlert = document.querySelector('.alert-toast');
            if (existingAlert) existingAlert.remove();

            // Crear nueva alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-toast position-fixed top-3 end-3`;
            alertDiv.style.zIndex = '1060';
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle'} me-2"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(alertDiv);

            // Auto-eliminar después de 3 segundos
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        /* ======================================================
           ESTADO GLOBAL
        ====================================================== */
        let currentPage = 1;
        const recordsPerPage = 10;

        /* ======================================================
           MODAL: ABRIR EDICIÓN CON SELECT2
        ====================================================== */
        function openEditModal(product) {
            // Llenar campos del formulario
            document.getElementById("editProductId").value = product.id;
            document.getElementById("editProductName").value = product.productName ?? "";
            document.getElementById("editBarcode").value = product.barcode ?? "";
            document.getElementById("editProductDescription").value = product.productDescription ?? "";
            document.getElementById("editUnitPrice").value = product.unitPrice != null ? product.unitPrice : "";
            document.getElementById("editStockMin").value = product.stockMin != null ? product.stockMin : "";

            // Inicializar Select2 en los elementos del modal
            $('#editBrandId').select2({
                dropdownParent: $('#editProductModal'),
                theme: 'bootstrap-5',
                placeholder: 'Seleccione una marca',
                allowClear: true,
                width: '100%',
                minimumResultsForSearch: 0 // permite escribir directamente al hacer click
            });

            $('#editCategoryId').select2({
                dropdownParent: $('#editProductModal'),
                theme: 'bootstrap-5',
                placeholder: 'Seleccione una categoría',
                allowClear: true,
                width: '100%',
                minimumResultsForSearch: 0
            });

            // Establecer valores después de inicializar Select2
            $('#editBrandId').val(product.brandId || "").trigger('change');
            $('#editCategoryId').val(product.categoryId || "").trigger('change');

            // Limpiar Select2 cuando el modal se cierra
            $('#editProductModal').off('hidden.bs.modal').on('hidden.bs.modal', function () {
                $('#editBrandId').val('').trigger('change');
                $('#editCategoryId').val('').trigger('change');
                $('#editBrandId').select2('destroy');
                $('#editCategoryId').select2('destroy');
            });

            // Mostrar el modal
            new bootstrap.Modal(document.getElementById("editProductModal")).show();
        }

        /* ======================================================
           MODAL: GUARDAR CAMBIOS (PATCH)
        ====================================================== */
        async function saveProductEdit() {
            const id = document.getElementById("editProductId").value;

            const unitPriceValue = document.getElementById("editUnitPrice").value;
            const stockMinValue = document.getElementById("editStockMin").value;
            const descriptionValue = document.getElementById("editProductDescription").value;

            // Obtener valores de Select2
            const brandId = $('#editBrandId').val();
            const categoryId = $('#editCategoryId').val();

            const dto = {
                productName: document.getElementById("editProductName").value || null,
                barcode: document.getElementById("editBarcode").value || null,
                productDescription: descriptionValue || null,
                unitPrice: unitPriceValue !== "" ? Number(unitPriceValue) : null,
                stockMin: stockMinValue !== "" ? Number(stockMinValue) : null,
                brandId: brandId || null,
                categoryId: categoryId || null
            };

            const response = await fetch(`/api/Product/${id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dto)
            });

            const result = await response.json();

            if (result.isSuccess) {
                // Cerrar modal y limpiar Select2
                $('#editBrandId').select2('destroy');
                $('#editCategoryId').select2('destroy');

                bootstrap.Modal.getInstance(
                    document.getElementById("editProductModal")
                ).hide();

                fetchProducts(currentPage);
            } else {
                alert(result.message);
            }
        }

        /* ======================================================
           OBTENER PRODUCTOS (API)
        ====================================================== */
        async function fetchProducts(page = 1) {
            currentPage = page;

            const filterInput = document.getElementById("filterInput");
            const categoryFilter = document.getElementById("categoryFilter");
            const brandFilter = document.getElementById("brandFilter");
            const stockMin = document.getElementById("stockMin");
            const stockMax = document.getElementById("stockMax");
            const statusFilter = document.getElementById("statusFilter");

            const tableBody = document.getElementById("productTableBody");
            const paginationContainer = document.getElementById("paginationContainer");
            const loading = document.getElementById("loadingIndicator");

            const filter = encodeURIComponent(filterInput.value.trim());
            const categoryId = categoryFilter.value;
            const brandId = brandFilter.value;
            const stockMinVal = stockMin.value;
            const stockMaxVal = stockMax.value;
            const status = statusFilter.value;

            loading.classList.remove("invisible");
            tableBody.innerHTML = "";
            paginationContainer.innerHTML = "";

            let url = `https://localhost:7172/api/Product/paginated?Filter=${filter}&Page=${page}&RecordsPerPage=${recordsPerPage}`;
            if (categoryId) url += `&CategoryId=${categoryId}`;
            if (brandId) url += `&BrandId=${brandId}`;
            if (stockMinVal) url += `&StockMin=${stockMinVal}`;
            if (stockMaxVal) url += `&StockMax=${stockMaxVal}`;
            if (status) url += `&Status=${status}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data?.result?.list?.length > 0) {
                    data.result.list.forEach(p => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${p.productName}</td>
                            <td>${p.barcode}</td>
                            <td>${p.brandName}</td>
                            <td>${p.categoryName}</td>
                            <td>${p.unitPrice}</td>
                            <td>${p.currentStock ?? 0}</td>
                            <td>
                                <span class="badge ${p.status === 'Activo' ? 'bg-success' : 'bg-secondary'}">
                                    ${p.status}
                                </span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-warning"
                                    onclick='openEditModal(${JSON.stringify(p)})'>
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-danger"
                                    onclick='openDeactivateModal("${p.id}", "${p.productName}")'>
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });

                    updatePagination(data.result.currentPage, data.result.totalPages);
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                No hay productos registrados.
                            </td>
                        </tr>`;
                }

            } catch (error) {
                console.error(error);
            } finally {
                loading.classList.add("invisible");
            }
        }

        /* ======================================================
           PAGINACIÓN
        ====================================================== */
        function updatePagination(current, total) {
            const paginationContainer = document.getElementById("paginationContainer");
            if (total <= 1) return;

            const createItem = (text, page, disabled, active) => {
                const li = document.createElement("li");
                li.className = `page-item${disabled ? " disabled" : ""}${active ? " active" : ""}`;
                li.innerHTML = `<a class="page-link" href="#">${text}</a>`;
                li.onclick = e => {
                    e.preventDefault();
                    if (!disabled) fetchProducts(page);
                };
                return li;
            };

            paginationContainer.appendChild(createItem("Anterior", current - 1, current === 1));
            for (let i = 1; i <= total; i++)
                paginationContainer.appendChild(createItem(i, i, false, i === current));
            paginationContainer.appendChild(createItem("Siguiente", current + 1, current === total));
        }

        /* ======================================================
           CARGA INICIAL
        ====================================================== */
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("applyFilters")
                .addEventListener("click", () => fetchProducts(1));

            let typingTimer;
            document.getElementById("filterInput")
                .addEventListener("input", () => {
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(() => fetchProducts(1), 300);
                });

            fetchProducts(currentPage);
        });
    </script>
}

<!---------------------------------------------------------------------->
<!--------------------------- AdminLayout ------------------------------>
<!---------------------------------------------------------------------->
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Ventas";
}

<!---------------------------------------------------------------------->
<!----------------------------- Styles --------------------------------->
<!---------------------------------------------------------------------->

<style>
    /* Estilos para el modal de confirmación */
    #deactivateModal .modal-dialog {
        max-width: 400px;
    }

    #deactivateModal .modal-body {
        padding: 2rem 1.5rem;
    }

    /* Animación para alertas toast */
    .alert-toast {
        animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    @@keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @@keyframes fadeOut {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }

    .modal-edit-product {
        max-width: 1100px; /* ~10% más que modal-lg */
    }

    .pagination {
        margin-bottom: 0;
    }

    .filter-pill {
        border-radius: 999px;
        height: 42px; /* antes 48 */
        font-size: 14px; /* antes 15 */
    }

    .filter-search {
        height: 40px;
        font-size: 14px;
    }


    .filter-pill::placeholder {
        color: #6c757d;
    }

    .form-select.filter-pill {
        padding-right: 2.5rem;
    }

    .btn-main.filter-pill {
        font-size: 15px;
    }


    body {
        background-color: #eef1f4;
    }

    .products-card {
        max-width: 1400px;
        margin: 1rem auto; /* antes 2rem */
        border-radius: 20px;
        background-color: #f8f9fa;
        box-shadow: 0 20px 40px rgba(0,0,0,.08);
        border: 1px solid #e3e6ea;
    }


    .filters-card {
        background-color: #f6f8fa; /* más cercano al fondo */
        border: 1px solid #e5e8eb;
    }



    .form-control,
    .form-select {
        border-radius: 12px;
    }

        .form-control:focus,
        .form-select:focus {
            border-color: #393d42;
            box-shadow: 0 0 0 .15rem rgba(57,61,66,.25);
        }

    .btn-main {
        background-color: #393d42;
        color: #fff;
        border-radius: 20px;
        padding: .5rem 1.6rem;
    }

        .btn-main:hover {
            background-color: #2f3338;
            color: #fff;
        }

    .table thead th {
        background-color: #f1f3f5;
        font-size: 14px;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .pagination .page-link {
        color: #393d42;
        border-radius: 10px;
    }

    .pagination .active .page-link {
        background-color: #393d42;
        border-color: #393d42;
        color: #fff;
    }

    #stockMin,
    #stockMax {
        width: 120px;
        min-width: 120px;
    }

    .text-muted {
        color: #6c757d !important;
    }

    .table td,
    .table th {
        padding: 0.55rem 0.75rem;
        font-size: 14px;
        vertical-align: middle;
    }

    }
</style>

<!-------------------------------------------------------------------->
<!----------------------------- View --------------------------------->
<!-------------------------------------------------------------------->

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">Gestión de Ventas</h4>
        <a class="btn btn-main" href="@Url.Action("Register", "AdminSales")">
            <i class="bi bi-plus-circle"></i> Registrar venta
        </a>
</div>

<!----------------------------- Filtros --------------------------------->
<div class="card filters-card p-3 mb-3">

    <!-- Fila principal -->
    <div class="d-flex align-items-center gap-3">

        <!-- Buscar -->
        <input type="text"
               id="filterInput"
               class="form-control filter-pill filter-search flex-grow-1"
               placeholder="Buscar por nombre o código" />

        <!-- Botón filtros (icon only, armonioso) -->
        <button class="btn btn-light filter-pill px-3"
                data-bs-toggle="collapse"
                data-bs-target="#advancedFilters"
                title="Filtros avanzados">
            <i class="bi bi-sliders"></i>
        </button>

    </div>

    <!-- Filtros avanzados (MISMO CARD) -->
    <div class="collapse mt-3" id="advancedFilters">
        <div class="d-flex flex-wrap gap-3 align-items-center">

            <!-- Filtro año -->
            <select id="yearFilter" class="form-select filter-pill" style="width:120px">
                <option value="">Año</option>
            </select>

            <!-- Filtro mes -->
            <select id="monthFilter" class="form-select filter-pill" style="width:140px">
                <option value="">Mes</option>
                <option value="1">Enero</option>
                <option value="2">Febrero</option>
                <option value="3">Marzo</option>
                <option value="4">Abril</option>
                <option value="5">Mayo</option>
                <option value="6">Junio</option>
                <option value="7">Julio</option>
                <option value="8">Agosto</option>
                <option value="9">Septiembre</option>
                <option value="10">Octubre</option>
                <option value="11">Noviembre</option>
                <option value="12">Diciembre</option>
            </select>

            <!--
            <select id="statusFilter" class="form-select filter-pill" style="width:140px">
                <option value="">Estado</option>
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
            </select>

            <input type="number"
                   id="stockMin"
                   class="form-control filter-pill"
                   placeholder="Stock mín" />

            <input type="number"
                   id="stockMax"
                   class="form-control filter-pill"
                   placeholder="Stock máx" />
                   -->

            <button id="applyFilters"
                    class="btn btn-main filter-pill px-4">
                Aplicar
            </button>

        </div>
    </div>

</div>

<!----------------------------- Tabla --------------------------------->

<div class="card products-card" id="productCard">
    <div id="loadingIndicator"
         class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center bg-white bg-opacity-75 invisible"
         style="z-index: 1000;">
        <div class="spinner-border" style="color:#393d42"></div>
        <div class="mt-2">Cargando productos...</div>
    </div>

    <div class="card-body p-3">

        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
                <thead>
                    <tr>
                        <th>Codigo</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>Tipo</th>
                        <th>Usuario</th>
                        <th>Cliente</th>
                    </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
            </table>
        </div>
        <!----------------------------- Paginación --------------------------------->
        <nav class="mt-2">
            <ul class="pagination justify-content-center" id="paginationContainer"></ul>
        </nav>
    </div>
</div>

<script>
        /* ======================================================
           AUTH FETCH (JWT)
        ====================================================== */
        window.authFetch = async (url, options = {}) => {
            const token = localStorage.getItem("token");

            return fetch(url, {
                ...options,
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`,
                    ...(options.headers || {})
                }
            });
        };
        /* ======================================================
           ESTADO GLOBAL
        ====================================================== */
        let currentPage = 1;
        const recordsPerPage = 10;

            /* ======================================================
               OBTENER PRODUCTOS (API)
            ====================================================== */

    async function fetchSales(page = 1) {
        currentPage = page;

        const filterInput = document.getElementById("filterInput");
        const year = document.getElementById("yearFilter").value;
        const month = document.getElementById("monthFilter").value;

        const tableBody = document.getElementById("productTableBody");
        const paginationContainer = document.getElementById("paginationContainer");

        const filter = encodeURIComponent(filterInput.value.trim());

        // 🔹 Siempre limpiar
        tableBody.innerHTML = "";
        paginationContainer.innerHTML = "";

        let startDate = "";
        let endDate = "";

        // 🔹 Construcción de fechas (opcional)
        if (year) {
            const start = new Date(year, month ? month - 1 : 0, 1);
            const end = month
                ? new Date(year, month, 1)
                : new Date(Number(year) + 1, 0, 1);

            startDate = start.toISOString();
            endDate = end.toISOString();
        }

        // 🔹 URL base (siempre)
        let url = `https://localhost:7172/api/sale/paginated?Filter=${filter}&Page=${page}&RecordsPerPage=${recordsPerPage}`;

        // 🔹 Fechas solo si existen
        if (startDate && endDate) {
            url += `&StartDate=${encodeURIComponent(startDate)}&EndDate=${encodeURIComponent(endDate)}`;
        }

        try {
            const response = await authFetch(url);
            const data = await response.json();

            const sales = data?.result?.list;

    if (sales && sales.length > 0) {
        sales.forEach(s => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${s.saleNumber}</td>
                <td>${s.saleDateOnly}</td>
                <td>${s.saleTimeOnly}</td>
                <td>${s.totalAmount}</td>
                <td>${s.paymentStatus}</td>
                <td>${s.saleType}</td>
                <td>${s.userName}</td>
                <td>${s.customerName}</td>

            `;
            tableBody.appendChild(row);
        });

        updatePagination(data.result.currentPage, data.result.totalPages);
    } else {
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    No hay ventas para los filtros seleccionados.
                </td>
            </tr>`;
    }
        } catch (error) {
            console.error("Error cargando ventas:", error);
        }
    }



            /* ======================================================
               PAGINACIÓN
            ====================================================== */
            function updatePagination(current, total) {
                const paginationContainer = document.getElementById("paginationContainer");
                if (total <= 1) return;

                const createItem = (text, page, disabled, active) => {
                    const li = document.createElement("li");
                    li.className = `page-item${disabled ? " disabled" : ""}${active ? " active" : ""}`;
                    li.innerHTML = `<a class="page-link" href="#">${text}</a>`;
                    li.onclick = e => {
                        e.preventDefault();
                        if (!disabled) fetchSales(page);
                    };
                    return li;
                };

                paginationContainer.appendChild(createItem("Anterior", current - 1, current === 1));
                for (let i = 1; i <= total; i++)
                    paginationContainer.appendChild(createItem(i, i, false, i === current));
                paginationContainer.appendChild(createItem("Siguiente", current + 1, current === total));
            
            }
            /* ======================================================
               Filtro por tiempo
            ====================================================== */
            function loadYears() {
                const yearSelect = document.getElementById("yearFilter");
                const currentYear = new Date().getFullYear();

                for (let y = currentYear; y >= currentYear - 1; y--) {
                    const option = document.createElement("option");
                    option.value = y;
                    option.textContent = y;
                    yearSelect.appendChild(option);
                }
            }

            /* ======================================================
               CARGA INICIAL
            ====================================================== */
    document.addEventListener("DOMContentLoaded", () => {

        loadYears(); // carga los años en el select

        // 🔹 Deshabilitar mes hasta que se seleccione año
        const yearFilter = document.getElementById("yearFilter");
        const monthFilter = document.getElementById("monthFilter");

        monthFilter.disabled = true; // inicialmente deshabilitado

        yearFilter.addEventListener("change", e => {
            monthFilter.disabled = !e.target.value;

            // opcional: resetear mes cuando cambia el año
            if (!e.target.value) {
                monthFilter.value = "";
            }
        });

        // 🔹 Aplicar filtros
        document.getElementById("applyFilters")
            .addEventListener("click", () => fetchSales(1));

        // 🔹 Búsqueda por texto con delay
        let typingTimer;
        document.getElementById("filterInput")
            .addEventListener("input", () => {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => fetchSales(1), 300);
            });

        // 🔹 Carga inicial
        fetchSales();
    });

</script>
